platform :ios, '18.0'
install! 'cocoapods', :disable_input_output_paths => true

# Resolve RN scripts via Node to support workspaces and custom layouts
require 'open3'

def node_require(script)
  cmd = ['node', '-p', "require.resolve('#{script}', {paths: [process.argv[1]]})", __dir__]
  resolved, status = Open3.capture2(*cmd)
  raise "Unable to resolve #{script}" unless status.success?
  require resolved.strip
end

node_require('react-native/scripts/react_native_pods.rb')

project_candidates = Dir['*.xcodeproj'] + Dir['**/*.xcodeproj']
project_path = project_candidates.first
raise "No .xcodeproj found near Podfile (#{__dir__})" unless project_path

project project_path
app_target = File.basename(project_path, '.xcodeproj')

USE_FLIPPER = ENV['USE_FLIPPER'] == '1'
NEW_ARCH_ENABLED = ENV['RCT_NEW_ARCH_ENABLED'] == '1'

target app_target do
  use_frameworks! :linkage => :static

  config = (use_native_modules! rescue nil) || {}
  react_native_path = config[:reactNativePath] || File.expand_path('../node_modules/react-native', __dir__)

  use_react_native!(
    :path => react_native_path,
    :hermes_enabled => true,
    :new_arch_enabled => true,
    :fabric_enabled => NEW_ARCH_ENABLED,
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  # Codegen pods (ReactCodegen + ReactAppDependencyProvider) are handled automatically by use_react_native! using :app_path

  if USE_FLIPPER
    use_flipper!({ 'Flipper' => '0.203.0' })
  end

  post_install do |installer|
    installer.pods_project.build_configurations.each do |c|
      c.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '18.0'
      # Build Simulator for arm64 on Apple Silicon runners
      c.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'x86_64'
    end
    installer.pods_project.targets.each do |t|
      t.build_configurations.each do |c|
        c.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '18.0'
        c.build_settings['ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES'] = 'NO'
        c.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'x86_64'
      end
    end
    react_native_post_install(installer)

    # Tidy warnings for a couple of pods
    installer.pods_project.targets.each do |t|
      if ['react-native-slider','RNCAsyncStorage'].include? t.name
        t.build_configurations.each do |cfg|
          cfg.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'
          cfg.build_settings['WARNING_CFLAGS'] ||= ['$(inherited)']
          cfg.build_settings['WARNING_CFLAGS'] << '-Wno-non-modular-include-in-framework-module'
        end
      end
    end

    # Make sure ReactCommon turbomodules headers are discoverable
    installer.pods_project.targets.each do |t|
      next unless t.name == 'ReactCommon'
      t.build_configurations.each do |cfg|
        cfg.build_settings['HEADER_SEARCH_PATHS'] ||= '$(inherited)'
        cfg.build_settings['HEADER_SEARCH_PATHS'] << ' $(PODS_ROOT)/Headers/Public/ReactCommon/ReactCommon/react/nativemodule/core'
      end
    end

    File.write('Pods/.ran_post_install', 'Post install executed successfully')
  end
end
