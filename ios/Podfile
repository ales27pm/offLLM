# React Native 0.81.x requires iOS 18.0
platform :ios, '18.0'
install! 'cocoapods', :disable_input_output_paths => true

def node_require(script)
  resolved = Pod::Executable.execute_command('node', ['-p',
    "require.resolve('#{script}', {paths: [process.argv[1]]})", __dir__
  ]).strip
  require resolved
end
node_require('react-native/scripts/react_native_pods.rb')

project_candidates = Dir['*.xcodeproj'] + Dir['**/*.xcodeproj']
project_path = project_candidates.first
raise "No .xcodeproj found near Podfile (#{__dir__})" unless project_path

project project_path
app_target = File.basename(project_path, '.xcodeproj')

target app_target do
  use_frameworks! :linkage => :static

  config = (use_native_modules! rescue nil) || {}
  react_native_path = config[:reactNativePath] || File.expand_path('../node_modules/react-native', __dir__)

  use_react_native!(
    :path => react_native_path,
    :hermes_enabled => true,
    :new_arch_enabled => true
  )

  post_install do |installer|
    installer.pods_project.build_configurations.each do |c|
      c.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '18.0'
      c.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
    end
    installer.pods_project.targets.each do |t|
      t.build_configurations.each do |c|
        c.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '18.0'
      end
    end
    react_native_post_install(installer)
    File.write('Pods/.ran_post_install', 'Post install executed successfully')
  end
end
