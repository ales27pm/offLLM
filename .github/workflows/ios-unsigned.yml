name: iOS Unsigned Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write # allow committing REPORT.md, report_agent.md
  actions: read
  checks: read

jobs:
  ios:
    runs-on: macos-14
    env:
      BUILD_DIR: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.1
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.1"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Set up Ruby & Bundler (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: ios

      - name: Install iOS tooling
        run: brew install xcodegen xcbeautify

      - name: Install Node deps
        run: npm run ci:install

      - name: iOS deps (xcodegen & pods)
        run: |
          cd ios
          xcodegen generate
          bundle install
          bundle exec pod install --repo-update

      - name: Codegen
        run: npm run codegen

      - name: Build (Unsigned Simulator) â€” with logs & xcresult
        run: |
          set -o pipefail
          mkdir -p "${BUILD_DIR}"
          cd ios
          xcodebuild \
            -workspace MyOfflineLLMApp.xcworkspace \
            -scheme MyOfflineLLMApp \
            -configuration Release \
            -sdk iphonesimulator \
            -resultBundlePath "../${BUILD_DIR}/MyOfflineLLMApp.xcresult" \
            CODE_SIGNING_ALLOWED=NO CODE_SIGN_IDENTITY='' CODE_SIGNING_REQUIRED=NO \
          > "../${BUILD_DIR}/xcodebuild.raw.log" 2>&1
          STATUS=$?
          xcbeautify --generator reporter < "../${BUILD_DIR}/xcodebuild.raw.log" > "../${BUILD_DIR}/xcodebuild.log" || cp "../${BUILD_DIR}/xcodebuild.raw.log" "../${BUILD_DIR}/xcodebuild.log"
          tail -n 200 "../${BUILD_DIR}/xcodebuild.log"
          exit $STATUS

      - name: Generate Codex reports
        if: always()
        run: |
          test -f "${BUILD_DIR}/xcodebuild.log" || (echo "xcodebuild.log missing" && ls -la "${BUILD_DIR}" || true)
          test -d "${BUILD_DIR}/MyOfflineLLMApp.xcresult" || (echo "xcresult missing" && ls -la "${BUILD_DIR}" || true)
          npm run codex:analyze

      - name: Snapshot reports for commit
        if: always()
        run: |
          ts=$(date +%Y%m%d-%H%M%S)
          mkdir -p ci-reports/$ts
          [ -f reports/REPORT.md ] && cp reports/REPORT.md ci-reports/$ts/
          [ -f reports/report_agent.md ] && cp reports/report_agent.md ci-reports/$ts/
          [ -f build/xcodebuild.log ] && cp build/xcodebuild.log ci-reports/$ts/
          [ -d build/MyOfflineLLMApp.xcresult ] && ln -sf ../../build/MyOfflineLLMApp.xcresult ci-reports/$ts/MyOfflineLLMApp.xcresult

      - name: Upload /reports artifact (backstop)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-codex-reports
          path: reports
          if-no-files-found: warn

      - name: Commit reports to repo
        if: always()
        run: |
          ALLOW_DIRTY=1 npm run reports:commit || true
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore(reports): update CI reports [skip ci]"
            git push
          else
            echo "No report changes to commit."
          fi
