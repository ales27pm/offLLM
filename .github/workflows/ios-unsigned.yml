name: iOS (unsigned)

on:
  workflow_dispatch:
  push:
    branches: [main, master]
  pull_request:

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  build-ios-unsigned:
    runs-on: macos-14

    env:
      RCT_NEW_ARCH_ENABLED: "1"
      USE_HERMES: "true"
      SCHEME: monGARS
      CONFIGURATION: Release
      BUILD_DIR: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.2"

      - name: Show selected Xcode
        run: |
          set -euo pipefail
          xcodebuild -version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install JS dependencies
        run: |
          set -euo pipefail
          if [ -f yarn.lock ]; then
            corepack enable
            yarn --version
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      - name: Generate Xcode project (XcodeGen) and install pods
        run: |
          set -euo pipefail

          # XcodeGen (install if missing)
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi

          # Seed XcodeGen spec if missing
          if [ ! -f ios/project.yml ]; then
            echo "No ios/project.yml found â€” seeding a minimal XcodeGen spec."
            mkdir -p ios
            cat > ios/project.yml <<'YML'
name: monGARS
options:
  bundleIdPrefix: com.example
  deploymentTarget:
    iOS: "18.0"
targets:
  monGARS:
    type: application
    platform: iOS
    sources:
      - path: ..
        excludes:
          - ios/**/*
          - android/**/*
          - node_modules/**/*
    settings:
      PRODUCT_BUNDLE_IDENTIFIER: com.example.monGARS
      INFOPLIST_FILE: ios/Info.plist
YML

            if [ ! -f ios/Info.plist ]; then
              cat > ios/Info.plist <<'PLIST'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>CFBundleName</key><string>monGARS</string>
  <key>CFBundleIdentifier</key><string>com.example.monGARS</string>
  <key>CFBundleExecutable</key><string>$(EXECUTABLE_NAME)</string>
  <key>CFBundlePackageType</key><string>APPL</string>
  <key>UISupportedInterfaceOrientations</key>
  <array><string>UIInterfaceOrientationPortrait</string></array>
  <key>LSRequiresIPhoneOS</key><true/>
</dict>
</plist>
PLIST
            fi
          fi

          # Generate .xcodeproj next to Podfile so CocoaPods can find it
          xcodegen generate --spec ios/project.yml --project ios/monGARS.xcodeproj

          # CocoaPods
          gem install cocoapods -N
          cd ios
          pod install --repo-update --verbose

      - name: Build (unsigned) and package IPA
        run: |
          set -euo pipefail

          rm -rf "${BUILD_DIR}"
          mkdir -p "${BUILD_DIR}"

          xcodebuild \
            -workspace ios/monGARS.xcworkspace \
            -scheme "${SCHEME}" \
            -configuration "${CONFIGURATION}" \
            -sdk iphoneos \
            -derivedDataPath "${BUILD_DIR}/DerivedData" \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY="" \
            | tee "${BUILD_DIR}/xcodebuild.log"

          APP_PRODUCTS="${BUILD_DIR}/DerivedData/Build/Products/${CONFIGURATION}-iphoneos"
          APP_PATH="${APP_PRODUCTS}/${SCHEME}.app"

          if [ ! -d "${APP_PATH}" ]; then
            echo "App not found at ${APP_PATH}"
            exit 65
          fi

          mkdir -p "${BUILD_DIR}/Payload"
          cp -R "${APP_PATH}" "${BUILD_DIR}/Payload/"
          (cd "${BUILD_DIR}" && /usr/bin/zip -qry "${SCHEME}-unsigned.ipa" Payload)

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ipa-unsigned
          path: build/monGARS-unsigned.ipa
          if-no-files-found: error
          retention-days: 7

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-log
          path: build/xcodebuild.log
          if-no-files-found: warn
          retention-days: 7

      - name: Upload products (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: products-${{ env.CONFIGURATION }}-iphoneos
          path: build/DerivedData/Build/Products/${{ env.CONFIGURATION }}-iphoneos/**
          if-no-files-found: warn
          retention-days: 7