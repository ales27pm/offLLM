name: iOS Unsigned Build (monGARS)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ios-unsigned-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-unsigned:
    runs-on: macos-15
    env:
      RCT_NEW_ARCH_ENABLED: "1"
      USE_HERMES: "true"
      SCHEME: "monGARS"
      CONFIGURATION: "Release"
      BUILD_DIR: build
      TEAM_NAME: "27pm"
      PROJECT_NAME: "monGARS"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show installed Xcodes
        run: ls -1 /Applications | sed -n 's/^Xcode.*/&/p'

      - name: Select Xcode 16.4 (attempt)
        id: xcode164
        continue-on-error: true
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"

      - name: Select Xcode 16.2 (fallback)
        if: ${{ steps.xcode164.outcome == 'failure' }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.2"

      - name: Confirm Xcode
        id: xcodever
        shell: bash
        run: |
          set -e
          xcodebuild -version
          SEL="$(xcodebuild -version | head -n1 | awk '{print $2}')"
          echo "xcode=$SEL" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install JS deps
        run: npm ci

      - name: Install Homebrew deps
        run: brew install xcodegen

      # âœ… No heredocs. We write files via Node to avoid YAML/indent issues.
      - name: Seed minimal XcodeGen spec if missing
        run: |
          node -e "
          const fs = require('fs');
          if (!fs.existsSync('ios')) fs.mkdirSync('ios', { recursive: true });
          if (!fs.existsSync('ios/project.yml')) {
            const y = [
              'name: monGARS',
              'options:',
              '  bundleIdPrefix: com.example',
              '  deploymentTarget:',
              '    iOS: \"18.0\"',
              'targets:',
              '  monGARS:',
              '    type: application',
              '    platform: iOS',
              '    sources:',
              '      - path: .',
              '        excludes:',
              '          - ios/**/*',
              '          - android/**/*',
              '          - node_modules/**/*',
              '    settings:',
              '      PRODUCT_BUNDLE_IDENTIFIER: com.example.monGARS',
              '      INFOPLIST_FILE: ios/Info.plist',
              ''
            ].join('\\n');
            fs.writeFileSync('ios/project.yml', y);
            if (!fs.existsSync('ios/Info.plist')) {
              const p = [
                '<?xml version=\"1.0\" encoding=\"UTF-8\"?>',
                '<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">',
                '<plist version=\"1.0\">',
                '<dict>',
                '  <key>CFBundleName</key><string>monGARS</string>',
                '  <key>CFBundleIdentifier</key><string>com.example.monGARS</string>',
                '  <key>CFBundleExecutable</key><string>$(EXECUTABLE_NAME)</string>',
                '  <key>CFBundlePackageType</key><string>APPL</string>',
                '  <key>UISupportedInterfaceOrientations</key>',
                '  <array><string>UIInterfaceOrientationPortrait</string></array>',
                '  <key>LSRequiresIPhoneOS</key><true/>',
                '</dict>',
                '</plist>',
                ''
              ].join('\\n');
              fs.writeFileSync('ios/Info.plist', p);
            }
            console.log('Seeded ios/project.yml and ios/Info.plist');
          } else {
            console.log('ios/project.yml already exists; skipping seeding.');
          }
          "

      - name: Generate .xcodeproj with XcodeGen
        working-directory: ios
        run: xcodegen generate

      - name: Verify project
        run: |
          if [ ! -d ios/monGARS.xcodeproj ] && [ ! -d ios/monGARS.xcworkspace ]; then
            echo "Xcode project not generated"
            ls -la ios || true
            exit 1
          fi

      - name: Setup Ruby (CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: ios

      - name: Install Pods
        working-directory: ios
        run: |
          bundle install --path vendor/bundle
          bundle exec pod repo update
          bundle exec pod install

      - name: Bootstrap, build, and package (single script)
        id: buildstep
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$BUILD_DIR"
          rm -rf "$BUILD_DIR/DerivedData"

          set +e
          xcodebuild \
            -workspace ios/monGARS.xcworkspace \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath "$BUILD_DIR/DerivedData" \
            -resultBundlePath "$BUILD_DIR/$SCHEME.xcresult" \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY="" \
            | tee "$BUILD_DIR/xcodebuild.log"
          STATUS=${PIPESTATUS[0]}
          set -e

          APP_DIR="$BUILD_DIR/DerivedData/Build/Products/${CONFIGURATION}-iphoneos"
          APP_PATH="$APP_DIR/$SCHEME.app"
          if [ -d "$APP_PATH" ]; then
            rm -rf "$BUILD_DIR/Payload"
            mkdir -p "$BUILD_DIR/Payload"
            cp -R "$APP_PATH" "$BUILD_DIR/Payload/"
            (cd "$BUILD_DIR" && zip -qry offLLM-unsigned.ipa Payload)
            (cd "$APP_DIR" && zip -qry "$PWD/../../$SCHEME.app.zip" "$SCHEME.app")
          fi

          if command -v xcrun >/dev/null 2>&1 && [ -d "$BUILD_DIR/$SCHEME.xcresult" ]; then
            xcrun xcresulttool get --format json --path "$BUILD_DIR/$SCHEME.xcresult" > "$BUILD_DIR/$SCHEME.xcresult.json" || true
          fi

          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          exit "$STATUS"

      - name: Upload IPA
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa-xcode-${{ steps.xcodever.outputs.xcode }}-attempt-${{ github.run_attempt }}
          path: |
            build/offLLM-unsigned.ipa
            build/monGARS.app.zip
          if-no-files-found: ignore
          overwrite: true

      - name: Upload logs & xcresult
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-reports-xcode-${{ steps.xcodever.outputs.xcode }}-attempt-${{ github.run_attempt }}
          path: |
            build/xcodebuild.log
            build/monGARS.xcresult
            build/monGARS.xcresult.json
          if-no-files-found: ignore
          overwrite: true
