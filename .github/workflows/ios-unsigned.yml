name: iOS Unsigned Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write # allow committing REPORT.md, report_agent.md
  actions: read
  checks: read

jobs:
  ios:
    runs-on: macos-15
    env:
      BUILD_DIR: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.4
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Set up Ruby & Bundler (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
          working-directory: ios

      - name: Install iOS tooling
        run: brew install xcodegen

      - name: Run Robust Build Script
        run: bash build.sh

      - name: Parse Build Results
        run: node tools/xcresult-parser.js "${BUILD_DIR}/MyOfflineLLMApp.xcresult"

      - name: Commit reports to repo
        if: always()
        run: |
          ALLOW_DIRTY=1 npm run reports:commit || true
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore(reports): update CI reports [skip ci]"
            git push
          else
            echo "No report changes to commit."
          fi
