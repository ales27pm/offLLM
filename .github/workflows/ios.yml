---
name: ios (simulator)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  XCODE_VERSION: "16.4"

jobs:
  build:
    runs-on: macos-15 # newer image; arm64
    env:
      NODE_VERSION: 20
      RUBY_VERSION: 3.2
      DERIVED_DATA: ${{ github.workspace }}/build/DerivedData
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@c51a66b42363123fa82a6cfe02c60af4281dab93
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Set up Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install jq
        uses: dcarbone/install-jq-action@8867ddb4788346d7c22b72ea2e2ffe4d514c7bcb
        # jq keeps the parsing simple and resilient

      - name: Setup Ruby (3.2) + Bundler cache
        uses: ruby/setup-ruby@44511735964dcb71245e7e55f72539531f7bc0eb
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Install JS deps
        run: npm ci

      - name: Install XcodeGen (if needed)
        run: |
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew update
            brew install xcodegen
          fi

      - name: Generate Xcode project (XcodeGen)
        run: |
          (cd ios && xcodegen generate)

      - name: Install CocoaPods (via bundler)
        working-directory: ios
        run: |
          bundle exec pod install --repo-update

      - name: Detect workspace and scheme
        id: detect
        working-directory: ios
        run: |
          set -euo pipefail
          WS=$(ls -1 *.xcworkspace 2>/dev/null | head -n1 || true)
          if [ -z "${WS:-}" ]; then
            echo "::error::No .xcworkspace found in ios/. Run XcodeGen and CocoaPods first."
            exit 2
          fi
          SCHEME=$(xcodebuild -list -json -workspace "$WS" | python -c 'import json,sys;j=json.load(sys.stdin);s=j.get("workspace",{}).get("schemes",[]);print(s[0] if s else "")')
          if [ -z "${SCHEME:-}" ]; then
            echo "::error::No shared schemes found in $WS"
            exit 3
          fi
          echo "workspace=ios/$WS" >> "$GITHUB_OUTPUT"
          echo "workspace_name=$WS" >> "$GITHUB_OUTPUT"
          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: "Doctor: verify workspace"
        run: ./scripts/ios_doctor.sh

      - name: Resolve SPM
        env:
          WORKSPACE: ${{ steps.detect.outputs.workspace }}
          SCHEME: ${{ steps.detect.outputs.scheme }}
          DERIVED_DATA: ${{ env.DERIVED_DATA }}
        run: |
          set -euxo pipefail
          xcodebuild -resolvePackageDependencies \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -clonedSourcePackagesDirPath "$DERIVED_DATA/SourcePackages"

      - name: Prepare Simulator
        id: sim
        env:
          DERIVED_DATA: ${{ env.DERIVED_DATA }}
        run: |
          set -euxo pipefail
          RB="${DERIVED_DATA}/ResultBundle_build.xcresult"
          rm -rf "$RB"

          # Prime CoreSimulatorService; sometimes the first JSON call races and returns empty.
          xcodebuild -runFirstLaunch >/dev/null 2>&1 || true
          xcrun simctl list >/dev/null 2>&1 || true

          # Retry loop to obtain JSON (prevents JSONDecodeError on momentary empties)
          SIM_JSON=""
          for i in 1 2 3; do
            if SIM_JSON="$(xcrun simctl list -j runtimes devices devicetypes)"; then
              if [ -n "$SIM_JSON" ] && [ "${#SIM_JSON}" -gt 100 ]; then
                break
              fi
            fi
            echo "simctl JSON empty on attempt $i; retrying..."
            sleep 2
          done

          if [ -z "$SIM_JSON" ]; then
            echo "::error::No simulator JSON available from simctl after retries."
            exit 70
          fi

          # Prefer iOS 18.5 if present and available; else pick latest available iOS>=18
          HAS_185="$(echo "$SIM_JSON" | jq -r '.runtimes[] | select(.isAvailable and .name=="iOS 18.5") | .identifier' | head -1 || true)"
          if [ -n "$HAS_185" ]; then
            RUNTIME_ID="$HAS_185"
          else
            RUNTIME_ID="$(echo "$SIM_JSON" | jq -r '
              def v: .version // "0";
              def parse: (v | split(".") | map(tonumber));
              [ .runtimes[]
                | select(.isAvailable and (.identifier|startswith("com.apple.CoreSimulator.SimRuntime.iOS")))
                | select(((.version // "0") | startswith("18.")))
              ]
              | sort_by(.version | split(".") | map(tonumber))
              | last
              | .identifier // empty
            ' || true)"
          fi

          if [ -z "${RUNTIME_ID:-}" ]; then
            echo "::error::No available iOS 18.x Simulator runtime found."
            echo "$SIM_JSON" | head -c 5000 || true
            exit 70
          fi

          DEVICE_TYPE="$(echo "$SIM_JSON" | jq -r '.devicetypes[] | select(.name=="iPhone 16 Pro") | .identifier' | head -1 || true)"
          if [ -z "${DEVICE_TYPE:-}" ]; then
            DEVICE_TYPE="$(echo "$SIM_JSON" | jq -r '.devicetypes[] | select(.name|startswith("iPhone")) | .identifier' | head -1 || true)"
          fi
          if [ -z "${DEVICE_TYPE:-}" ]; then
            echo "::error::No iPhone device type found in simctl output."
            exit 71
          fi

          # Try to re-use an existing device for that runtime; else create a new one
          DEVICE_ID="$(echo "$SIM_JSON" | jq -r --arg rt "$RUNTIME_ID" --arg dt "$DEVICE_TYPE" '.devices[$rt][]? | select(.isAvailable and .deviceTypeIdentifier==$dt) | .udid' | head -1 || true)"
          if [ -z "${DEVICE_ID:-}" ]; then
            DEVICE_ID="$(xcrun simctl create "CI-iPhone" "$DEVICE_TYPE" "$RUNTIME_ID")"
          fi
          if [ -z "${DEVICE_ID:-}" ]; then
            echo "::error::Failed to create or find a simulator for runtime $RUNTIME_ID."
            exit 72
          fi

          echo "Runtime: $RUNTIME_ID"
          echo "DeviceType: $DEVICE_TYPE"
          echo "DeviceID: $DEVICE_ID"
          xcrun simctl boot "$DEVICE_ID" >/dev/null 2>&1 || true
          xcrun simctl bootstatus "$DEVICE_ID" -b
          echo "dest=id=$DEVICE_ID" >> "$GITHUB_OUTPUT"

      - name: Build (Simulator)
        env:
          WORKSPACE: ${{ steps.detect.outputs.workspace }}
          SCHEME: ${{ steps.detect.outputs.scheme }}
          DERIVED_DATA: ${{ env.DERIVED_DATA }}
          RESULT_BUNDLE: ${{ env.DERIVED_DATA }}/ResultBundle_build.xcresult
          DEST: ${{ steps.sim.outputs.dest }}
        run: |
          set -euxo pipefail
          xcodebuild -workspace "$WORKSPACE" \
                     -scheme "$SCHEME" \
                     -configuration Release \
                     -destination "$DEST" \
                     -derivedDataPath "$DERIVED_DATA" \
                     -resultBundlePath "$RESULT_BUNDLE" \
                     clean build
